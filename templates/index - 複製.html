<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>åœ°é»æŸ¥è©¢ App</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="/static/manifest.json" rel="manifest"/>
<script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("/static/service-worker.js")
                .then(reg => console.log("Service Worker registered:", reg.scope))
                .catch(err => console.error("Service Worker registration failed:", err));
        }
    </script>
<style>
        body { background-color: #121212; color: white; font-family: sans-serif; padding: 20px; }
        input, button { margin: 5px; padding: 8px; }
        .card { background-color: #2c2c2c; padding: 10px; margin: 10px 0; border-radius: 8px; }
    </style>
</head>
<body>
<h2>ğŸ” åœ°é»æŸ¥è©¢</h2>
<input id="keyword" placeholder="è¼¸å…¥åœ°é»åç¨±" type="text"/>
<button onclick="search()">æŸ¥è©¢</button>
<div id="results"></div>

<h2>â• æ–°å¢åœ°é»</h2>
<div>
<input id="add_name" placeholder="åœ°é»åç¨±"/>
<input id="add_address" placeholder="åœ°å€"/>
<input id="add_lnglat" placeholder="åº§æ¨™"/>
<input id="add_entry" placeholder="èµ°æ³•"/>
<input id="add_source" placeholder="é›»æº"/>
<input id="add_remark" placeholder="å‚™è¨»"/>
<button onclick="add()">æ–°å¢</button>
</div>







<script>


        function add() {
            const data = {
                box_name: document.getElementById("add_name").value,
                address: document.getElementById("add_address").value,
                lng_lat: document.getElementById("add_lnglat").value,
                entry_method: document.getElementById("add_entry").value,
                source_type: document.getElementById("add_source").value,
                remark: document.getElementById("add_remark").value
            };
			let box = document.getElementById("add_name").value;
			document.getElementById("keyword").value = document.getElementById("add_name").value;
            fetch("/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(() => search());
			
			document.getElementById("add_name").value = "";
			document.getElementById("add_address").value = "";
			document.getElementById("add_lnglat").value = "";
			document.getElementById("add_entry").value = "";
			document.getElementById("add_source").value = "";
			document.getElementById("add_remark").value = "";
			alert("æ–°å¢åœ°é»å" + box + "å·²æˆåŠŸ");
        }



        function remove(name) {
            const pwd = prompt("è«‹è¼¸å…¥å¯†ç¢¼åˆªé™¤");
            if (pwd !== "9487") return alert("å¯†ç¢¼éŒ¯èª¤");
            fetch("/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ box_name: name })
            }).then(() => search());
        }
    </script>

<script>
function renderCard(item) {
  return `
    <div class="card" id="card-${item.box_name}">
		<strong><span>${item.box_name}</span></strong><br>
		åœ°å€ï¼š<span><a href="https://www.google.com/maps/search/${item.address}" target="_blank">${item.address}</a></span><br>
		åº§æ¨™ï¼š<span><a href="https://www.google.com/maps?q=${item.lng_lat}" target="_blank">${item.lng_lat}</a></span><br>
		èµ°æ³•ï¼š<span>${item.entry_method}</span><br>
		é›»æºï¼š<span>${item.source_type}</span><br>
		å‚™è¨»ï¼š<span>${item.remark}</span><br>
		<button onclick="enableEdit('${item.box_name}')">ä¿®æ”¹</button>
		<button onclick='remove("${item.box_name}")'>åˆªé™¤</button>
    </div>
  `;
}

function enableEdit(boxName) {
  const card = document.getElementById(`card-${boxName}`);
  const spans = card.querySelectorAll("span");
  const values = Array.from(spans).map(s => s.textContent);
  card.innerHTML = `
    <div class="edit-form">
      <label>åœ°é»åç¨±: <input type="text" id="edit-box_name" value="${values[0]}"></label><br>
      <label>åœ°å€: <input type="text" id="edit-address" value="${values[1]}"></label><br>
      <label>åº§æ¨™: <input type="text" id="edit-lng_lat" value="${values[2]}"></label><br>
      <label>èµ°æ³•: <input type="text" id="edit-entry_method" value="${values[3]}"></label><br>
      <label>é›»æº: <input type="text" id="edit-source_type" value="${values[4]}"></label><br>
      <label>å‚™è¨»: <input type="text" id="edit-remark" value="${values[5]}"></label><br>
      <button onclick="saveEdit('${boxName}')">å„²å­˜</button>
      <button onclick="deleteCard('${boxName}')">åˆªé™¤</button>
    </div>
  `;
}

function saveEdit(originalBoxName) {
  const data = {
    original_box_name: originalBoxName,
    box_name: document.getElementById("edit-box_name").value,
    address: document.getElementById("edit-address").value,
    lng_lat: document.getElementById("edit-lng_lat").value,
    entry_method: document.getElementById("edit-entry_method").value,
    source_type: document.getElementById("edit-source_type").value,
    remark: document.getElementById("edit-remark").value
  };
  fetch("/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  }).then(res => res.json()).then(() => search());
}

function deleteCard(boxName) {
  fetch("/delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ box_name: boxName })
  }).then(res => res.json()).then(() => search());
}

function search() {
  const keyword = document.getElementById("keyword").value;
  fetch(`/search?keyword=${encodeURIComponent(keyword)}`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("results");
      container.innerHTML = data.map(renderCard).join("");
    });
}
</script>

</body>
</html>


<!-- Editable Card Template -->





<script>
document.querySelectorAll('.edit-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const card = btn.closest('.box-card');
    card.querySelectorAll('.editable').forEach(input => input.disabled = false);
    btn.style.display = 'none';
    card.querySelector('.save-btn').style.display = 'inline-block';
  });
});

document.querySelectorAll('.save-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const card = btn.closest('.box-card');
    const inputs = card.querySelectorAll('.editable');
    const originalBoxName = card.dataset.boxName;

    const data = {
      original_box_name: originalBoxName,
      box_name: inputs[0].value,
      address: inputs[1].value,
      lng_lat: inputs[2].value,
      entry_method: inputs[3].value,
      source_type: inputs[4].value,
      remark: inputs[5].value
    };

    const res = await fetch('/update', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });

    const result = await res.json();
    if (result.status === 'success') {
      alert('æ›´æ–°æˆåŠŸ');
      inputs.forEach(input => input.disabled = true);
      btn.style.display = 'none';
      card.querySelector('.edit-btn').style.display = 'inline-block';
      card.dataset.boxName = data.box_name;
    } else {
      alert('æ›´æ–°å¤±æ•—');
    }
  });
});
</script>
